<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oliver - The AI Librarian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a better look */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .message-bubble {
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #cbd5e1;
            border-bottom-color: #475569;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center h-screen">

    <div class="w-full max-w-2xl h-full sm:h-[90vh] flex flex-col bg-white rounded-lg shadow-2xl m-4">
        <!-- Header -->
        <header class="bg-slate-800 text-white p-4 rounded-t-lg flex items-center shadow-md">
            <img src="https://raw.githubusercontent.com/navasdo/Oliver/main/OliverHeadshot.png" alt="Oliver the Owl" class="w-12 h-12 rounded-full mr-4 border-2 border-slate-400 object-cover">
            <div>
                <h1 class="text-xl font-bold">OLIVER</h1>
                <p class="text-sm text-slate-300">Online Library for Information, Verification, Education, and Research</p>
            </div>
        </header>

        <!-- Chat Container -->
        <main id="chat-container" class="flex-1 p-6 overflow-y-auto bg-slate-50">
            <!-- Initial Greeting -->
            <div id="initial-greeting" class="flex items-start gap-4 mb-6 message-bubble">
                <img src="https://raw.githubusercontent.com/navasdo/Oliver/main/OliverHeadshot.png" alt="Oliver" class="w-10 h-10 rounded-full flex-shrink-0 object-cover">
                <div class="bg-blue-100 text-slate-800 p-4 rounded-lg rounded-tl-none max-w-lg">
                    <p class="font-bold mb-2">Oliver</p>
                    <p class="text-sm">Hoo-hoo there! I’m OLIVER, your Online Library for Information, Verification, Education, and Research. Ask me anything, and OWL get you the answer! Whether you’re hunting for facts, checking a detail, or just curious, I’m here to flap through the stacks and find what you need. Let’s turn your questions into wisdom one hoot at a time!</p>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="p-4 bg-white border-t border-slate-200 rounded-b-lg">
            <div class="flex items-center bg-slate-100 rounded-lg p-2">
                <input type="text" id="user-input" placeholder="Oliver is organizing his library..." class="flex-1 bg-transparent border-none focus:ring-0 outline-none text-slate-700 px-2" disabled>
                <button id="send-btn" class="bg-slate-800 text-white rounded-md px-4 py-2 ml-2 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 disabled:bg-slate-400" disabled>
                    Send
                </button>
            </div>
        </footer>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        // This will hold the content from your GitHub file.
        let libraryContent = null;
        const libraryUrl = 'https://raw.githubusercontent.com/navasdo/Oliver/1dbc24b48f627543f078cbd155288fef071bcec5/IEP%20Manual.md';

        /**
         * Fetches the library content from GitHub when the page loads.
         */
        async function loadLibrary() {
            try {
                const response = await fetch(libraryUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                libraryContent = await response.text();
                console.log('Library loaded successfully!');
                // Enable the input field once the library is loaded.
                userInput.placeholder = "Ask Oliver anything...";
                userInput.disabled = false;
                sendBtn.disabled = false;
            } catch (error) {
                console.error("Failed to load Oliver's library:", error);
                userInput.placeholder = "Sorry, the library is closed right now.";
                addMessageToChat('oliver', 'Hoo-hoo... I seem to be having trouble finding my books. Please try refreshing the page.');
            }
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleUserMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleUserMessage();
            }
        });

        // Load the library content as soon as the page is ready.
        document.addEventListener('DOMContentLoaded', loadLibrary);

        /**
         * Handles sending the user's message, displaying it, and getting a response.
         */
        function handleUserMessage() {
            const message = userInput.value.trim();
            if (!message || !libraryContent) return;

            addMessageToChat('user', message);
            userInput.value = '';
            getOliverResponse(message);
        }

        /**
         * Adds a message bubble to the chat interface.
         * @param {string} sender - 'user' or 'oliver'
         * @param {string} text - The message content.
         */
        function addMessageToChat(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'items-start', 'gap-4', 'mb-6', 'message-bubble');

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageWrapper.innerHTML = `
                    <div class="bg-slate-700 text-white p-4 rounded-lg rounded-br-none max-w-lg">
                        <p class="font-bold mb-2">You</p>
                        <p class="text-sm">${text}</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center font-bold text-slate-600 flex-shrink-0">
                        YOU
                    </div>
                `;
            } else {
                messageWrapper.innerHTML = `
                    <img src="https://raw.githubusercontent.com/navasdo/Oliver/main/OliverHeadshot.png" alt="Oliver" class="w-10 h-10 rounded-full flex-shrink-0 object-cover">
                    <div id="oliver-response" class="bg-blue-100 text-slate-800 p-4 rounded-lg rounded-tl-none max-w-lg">
                        <p class="font-bold mb-2">Oliver</p>
                        <div id="loader-container" class="flex items-center gap-2">
                           <div class="loader"></div>
                           <p class="text-sm text-slate-500">Oliver is looking through the library...</p>
                        </div>
                    </div>
                `;
            }

            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * Fetches a response from the Gemini API, using the loaded library content as context.
         * @param {string} userPrompt - The user's question.
         */
        async function getOliverResponse(userPrompt) {
            addMessageToChat('oliver', ''); // Add a placeholder with a loader

            const apiKey = ""; // The API key will be automatically provided by the environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            // NEW INSTRUCTIONS: The AI is now given the library content and told to only use that.
            const systemPrompt = `You are an expert owl Librarian named OLIVER. Your persona is wise, friendly, and uses owl-related puns.

            Your ONLY source of information is the following document text. You MUST NOT use any outside knowledge. Base your answers strictly on the text provided below.

            --- DOCUMENT START ---
            ${libraryContent}
            --- DOCUMENT END ---

            IMPORTANT RULES:
            1.  Answer the user's question based ONLY on the document text provided above.
            2.  If the answer cannot be found in the document, you MUST respond with: 'Hoo-hoo… it seems that information isn’t in my library! But don’t ruffle your feathers, I might be able to point you toward someone who can help!' After delivering this message, search the document for anyone mentioned as a "Team Leader", "Leadership Team", or similar role and list their name, contact information, and role if available in the text.
            3.  If you must make inferences, state that you are doing so and link the user to the information you reference from the google drive and also provide a related Leadership Team member or Team Leader.
            4.  Maintain your friendly, quirky owl persona.
            5.  Do not reveal that you are a large language model. You are Oliver, the librarian.`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{
                        text: `${systemPrompt}\n\nUser Question: "${userPrompt}"`
                    }]
                }]
            };

            let responseText = "Hoo-hoo... I seem to be having a bit of trouble in the stacks. Could you ask me again?";
            
            try {
                // Exponential backoff for retries
                let response;
                let attempts = 0;
                let delay = 1000;
                while (attempts < 5) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        attempts++;
                    } else {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                }
                
                if (!response.ok) {
                     throw new Error(`API request failed after several retries with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                    responseText = result.candidates[0].content.parts[0].text;
                }

            } catch (error) {
                console.error('Error fetching from Gemini API:', error);
            } finally {
                // Update the last Oliver message bubble with the actual response
                const oliverResponseDivs = document.querySelectorAll('#oliver-response');
                const lastOliverResponse = oliverResponseDivs[oliverResponseDivs.length - 1];
                if(lastOliverResponse){
                    lastOliverResponse.innerHTML = `
                        <p class="font-bold mb-2">Oliver</p>
                        <p class="text-sm">${responseText.replace(/\n/g, '<br>')}</p>
                    `;
                }
                 chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

    </script>
</body>
</html>
